{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>{% block title %}{{ page.title|default:"Cryptologicus" }}{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body
    class="bg-slate-950 text-slate-100"
    x-data
    x-bind:class="$store.ui.bodyClass"
    x-init="$store.ui.init($el)"
>
    {% include 'cryptologicus/partials/navbar.html' %}
    {% block content %}{% endblock %}
    {% include 'cryptologicus/partials/footer-dark.html' %}

    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x" defer></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('ui', {
                theme: localStorage.getItem('theme')
                    ?? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
                mobileDrawerOpen: false,
                rootEl: null,
                init(el) {
                    this.rootEl = el;
                    this.applyBody(el);
                    this.syncTheme();
                },
                get bodyClass() {
                    return this.theme === 'dark'
                        ? 'bg-slate-950 text-slate-100'
                        : 'bg-slate-50 text-slate-900';
                },
                applyBody(el) {
                    el.className = this.bodyClass;
                },
                syncTheme() {
                    document.documentElement.dataset.theme = this.theme;
                },
                toggleTheme() {
                    this.theme = this.theme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('theme', this.theme);
                    if (this.rootEl) {
                        this.applyBody(this.rootEl);
                    }
                    this.syncTheme();
                }
            });
        });

        document.body.addEventListener('htmx:afterSwap', function (event) {
            const target = event.detail.target;
            if (!target || target.id !== 'derivation-slot') return;

            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([target]).catch(function (err) {
                    console.error('MathJax typeset error:', err);
                });
            }
        });
    </script>
</body>
</html>
