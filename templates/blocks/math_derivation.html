{# cryptologicus/templates/blocks/math_derivation.html #}
{% load wagtailcore_tags %}

<div
  x-data="{ mode: '', loading: false }"
  class="mt-10 border border-slate-800 rounded-xl bg-slate-900/60 p-4 sm:p-5 space-y-3"
>
  <div class="flex items-center justify-between gap-2">
    <h2 class="text-sm font-semibold text-slate-100">
      Derivation <span class="text-slate-400 text-xs">(math mode)</span>
    </h2>

    <div class="inline-flex rounded-lg border border-slate-700 overflow-hidden text-xs">
      {% if self.intuitive %}
        <button
          type="button"
          @click="mode = 'intuitive'; loading = true"
          hx-get="{{ page.url }}derivation/?mode=intuitive&up_to=1"
          hx-target="#derivation-slot"
          hx-swap="innerHTML"
          class="px-3 py-1.5 border-r border-slate-700"
          :class="mode === 'intuitive'
            ? 'bg-emerald-600 text-slate-900'
            : 'bg-slate-900 text-slate-300 hover:bg-slate-800'"
        >
          {{ self.intuitive_title|default:"Intuitive" }}
        </button>
      {% endif %}

      {% if self.formal %}
        <button
          type="button"
          @click="mode = 'formal'; loading = true"
          hx-get="{{ page.url }}derivation/?mode=formal&up_to=1"
          hx-target="#derivation-slot"
          hx-swap="innerHTML"
          class="px-3 py-1.5"
          :class="mode === 'formal'
            ? 'bg-emerald-600 text-slate-900'
            : 'bg-slate-900 text-slate-300 hover:bg-slate-800'"
        >
          {{ self.formal_title|default:"Formal" }}
        </button>
      {% endif %}
    </div>
  </div>

  <p class="text-xs text-slate-400">
    Choose a mode and walk through the derivation step by step. Maths is rendered with MathJax.
  </p>

  <div class="relative">
    <div
      id="derivation-slot"
      class="mt-2 space-y-3 text-sm text-slate-100"
      x-show="!loading"
      x-transition.opacity
    >
      <p class="text-slate-400 text-xs">
        Select <span class="font-semibold">Intuitive</span> or <span class="font-semibold">Formal</span> to start.
      </p>
    </div>

    <div
      x-show="loading"
      x-transition.opacity
      class="absolute inset-0 flex items-center justify-center bg-slate-900/60"
    >
      <div class="text-xs text-slate-300 animate-pulse">
        Loading derivationâ€¦
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('htmx:afterSwap', function (event) {
      const target = event.detail.target;
      if (!target || target.id !== 'derivation-slot') return;

      const root = target.closest('[x-data]');
      if (root && root.__x) {
        root.__x.$data.loading = false;
      }
    });
  </script>
</div>